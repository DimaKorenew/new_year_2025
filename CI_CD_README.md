# üöÄ CI/CD –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

## –û–±–∑–æ—Ä

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç GitLab CI/CD –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–±–æ—Ä–∫–∏ –∏ –¥–µ–ø–ª–æ—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ staging –∏ production –æ–∫—Ä—É–∂–µ–Ω–∏—è.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Pipeline

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Release ‚îÇ‚îÄ‚îÄ‚ñ∂‚îÇ  Build  ‚îÇ‚îÄ‚îÄ‚ñ∂‚îÇ Deploy Stage ‚îÇ‚îÄ‚îÄ‚ñ∂‚îÇ Deploy Prod ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 1. Release Stage

**–¢—Ä–∏–≥–≥–µ—Ä—ã**: push –≤ –≤–µ—Ç–∫–∏ `main` –∏–ª–∏ `staging`

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–µ —Ç–µ–≥–∏:
- **Main –≤–µ—Ç–∫–∞**: `YY.WW.N` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `25.49.0`)
- **Staging –≤–µ—Ç–∫–∞**: `YY.WW.N-stage` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `25.49.0-stage`)

–§–æ—Ä–º–∞—Ç –≤–µ—Ä—Å–∏–∏:
- `YY` - –≥–æ–¥ (–¥–≤–µ —Ü–∏—Ñ—Ä—ã)
- `WW` - –Ω–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏ –≤ –≥–æ–¥—É
- `N` - –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä (0, 1, 2...)

### 2. Build Stage

**–¢—Ä–∏–≥–≥–µ—Ä—ã**: —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞

–í—ã–ø–æ–ª–Ω—è–µ—Ç:
1. –°–æ–±–∏—Ä–∞–µ—Ç Docker –æ–±—Ä–∞–∑—ã –¥–ª—è frontend –∏ backend
2. –ü—É—à–∏—Ç –æ–±—Ä–∞–∑—ã –≤ GitLab Container Registry
3. –¢–µ–≥–∏—Ä—É–µ—Ç –æ–±—Ä–∞–∑—ã –≤–µ—Ä—Å–∏–µ–π –∏–∑ `CI_COMMIT_TAG`

### 3. Deploy Stage

**Staging**:
- –¢—Ä–∏–≥–≥–µ—Ä: —Ç–µ–≥–∏ —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º `-stage`
- –î–µ–ø–ª–æ–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –•–æ—Å—Ç: –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ `inventory.ini` –≥—Ä—É–ø–ø–µ `[stage]`

**Production**:
- –¢—Ä–∏–≥–≥–µ—Ä: —Ç–µ–≥–∏ –±–µ–∑ —Å—É—Ñ—Ñ–∏–∫—Å–∞ `-stage`
- –¢—Ä–µ–±—É–µ—Ç **—Ä—É—á–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è** (`when: manual`)
- –•–æ—Å—Ç: –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ `inventory.ini` –≥—Ä—É–ø–ø–µ `[prod]`

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. GitLab CI/CD –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ GitLab: Settings ‚Üí CI/CD ‚Üí Variables

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–∞—â–∏—â—ë–Ω–Ω–∞—è |
|-----------|----------|------------|
| `SSH_PRIVATE_KEY` | SSH –∫–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä–∞–º | ‚úÖ |
| `CI_REGISTRY_PASSWORD` | –ü–∞—Ä–æ–ª—å –¥–ª—è Docker registry | ‚úÖ |
| `CI_REGISTRY_USER` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è Docker registry | ‚úÖ |
| `CI_REGISTRY` | URL registry (git.edimdoma.ru:5050) | ‚ùå |

### 2. Inventory –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `inventory.ini`:

```ini
[stage]
stage_server ansible_host=YOUR_STAGE_IP ansible_user=root ansible_python_interpreter=/usr/bin/python3

[prod]
prod_server ansible_host=YOUR_PROD_IP ansible_user=root ansible_python_interpreter=/usr/bin/python3
```

### 3. SSH –¥–æ—Å—Ç—É–ø

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:
1. SSH –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Ü–µ–ª–µ–≤—ã–µ —Å–µ—Ä–≤–µ—Ä—ã
2. –°–µ—Ä–≤–µ—Ä—ã –∏–º–µ—é—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Docker –∏ Docker Compose
3. –ü–æ—Ä—Ç—ã 22 (–∏–ª–∏ 222) –æ—Ç–∫—Ä—ã—Ç—ã –¥–ª—è GitLab Runner

## Workflow

### –î–µ–ø–ª–æ–π –Ω–∞ Staging

1. –°–¥–µ–ª–∞–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ
2. –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏ –∑–∞–ø—É—à—å—Ç–µ –≤ –≤–µ—Ç–∫—É `staging`:
   ```bash
   git checkout staging
   git add .
   git commit -m "feat: –Ω–æ–≤–∞—è —Ñ–∏—á–∞"
   git push origin staging
   ```
3. Pipeline –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
   - –°–æ–∑–¥–∞—Å—Ç —Ç–µ–≥ `YY.WW.N-stage`
   - –°–æ–±–µ—Ä—ë—Ç –æ–±—Ä–∞–∑—ã
   - –ó–∞–¥–µ–ø–ª–æ–∏—Ç –Ω–∞ staging —Å–µ—Ä–≤–µ—Ä

### –î–µ–ø–ª–æ–π –Ω–∞ Production

1. –°–º—ë—Ä–∂—å—Ç–µ staging –≤ main:
   ```bash
   git checkout main
   git merge staging
   git push origin main
   ```
2. Pipeline —Å–æ–∑–¥–∞—Å—Ç production —Ç–µ–≥ `YY.WW.N`
3. –°–æ–±–µ—Ä—ë—Ç production –æ–±—Ä–∞–∑—ã
4. **–î–æ–∂–¥–∏—Ç–µ—Å—å —Å–±–æ—Ä–∫–∏, –∑–∞—Ç–µ–º –≤—Ä—É—á–Ω—É—é –∑–∞–ø—É—Å—Ç–∏—Ç–µ** –¥–µ–ø–ª–æ–π –≤ GitLab UI:
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ CI/CD ‚Üí Pipelines
   - –ù–∞–π–¥–∏—Ç–µ –Ω—É–∂–Ω—ã–π pipeline
   - –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ‚ñ∂Ô∏è –¥–ª—è `deploy_prod`

### –†—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–µ–≥ –≤—Ä—É—á–Ω—É—é:

```bash
# Staging
git tag 25.49.0-stage
git push origin 25.49.0-stage

# Production
git tag 25.49.0
git push origin 25.49.0
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤

–ù–∞ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–µ—Ä–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

```
/APP/
‚îî‚îÄ‚îÄ new_year_2025/
    ‚îú‚îÄ‚îÄ docker-compose.yml    # –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –∏–∑ —Ä–µ–ø–æ
    ‚îú‚îÄ‚îÄ nginx.conf            # –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –∏–∑ —Ä–µ–ø–æ
    ‚îî‚îÄ‚îÄ (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ volumes)
```

## Ansible Playbook

`deploy.yml` –≤—ã–ø–æ–ª–Ω—è–µ—Ç:

1. ‚úÖ –°–æ–∑–¥–∞—ë—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `/APP/new_year_2025/`
2. ‚úÖ –ö–æ–ø–∏—Ä—É–µ—Ç `docker-compose.yml` –∏ `nginx.conf`
3. ‚úÖ –õ–æ–≥–∏–Ω–∏—Ç—Å—è –≤ Docker Registry
4. ‚úÖ –ü—É–ª–∏—Ç –Ω–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã
5. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –Ω–æ–≤—ã–º–∏ –æ–±—Ä–∞–∑–∞–º–∏
6. ‚úÖ –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã (—Å—Ç–∞—Ä—à–µ 72 —á–∞—Å–æ–≤)

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```bash
# SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh root@YOUR_SERVER_IP

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
cd /APP/new_year_2025
docker compose ps

# –õ–æ–≥–∏
docker compose logs -f frontend
docker compose logs -f backend

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
docker compose restart
```

### Health Checks

–û–±–∞ —Å–µ—Ä–≤–∏—Å–∞ –∏–º–µ—é—Ç health checks:

- **Frontend**: `http://YOUR_SERVER:8088`
- **Backend**: `http://YOUR_SERVER:3001/health`

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ health
docker inspect --format='{{.State.Health.Status}}' new_year_frontend
docker inspect --format='{{.State.Health.Status}}' new_year_backend
```

## –û—Ç–∫–∞—Ç (Rollback)

–ï—Å–ª–∏ –¥–µ–ø–ª–æ–π –≤—ã–∑–≤–∞–ª –ø—Ä–æ–±–ª–µ–º—ã:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏

```bash
ssh root@YOUR_SERVER
cd /APP/new_year_2025

# –ò–∑–º–µ–Ω–∏—Ç–µ –≤–µ—Ä—Å–∏—é –≤ .env –∏–ª–∏ –≤—Ä—É—á–Ω—É—é
export CI_COMMIT_TAG=25.48.5  # –ø—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è

docker compose pull
docker compose up -d
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–π —Ä–µ–¥–µ–ø–ª–æ–π

1. –ù–∞–π–¥–∏—Ç–µ —Ä–∞–±–æ—á–∏–π —Ç–µ–≥ –≤ GitLab
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ pipeline –¥–ª—è —ç—Ç–æ–≥–æ —Ç–µ–≥–∞ –≤—Ä—É—á–Ω—É—é
3. –î–µ–ø–ª–æ–π—Ç–µ –µ–≥–æ

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### Pipeline –ø–∞–¥–∞–µ—Ç –Ω–∞ build

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Docker registry –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
docker login git.edimdoma.ru:5050 -u gitlab-ci-token -p $CI_JOB_TOKEN

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ runner
df -h
docker system df
```

### Ansible –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SSH –∫–ª—é—á
ssh -i ~/.ssh/your_key root@YOUR_SERVER_IP

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ inventory
ansible all -i inventory.ini -m ping
```

### –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
docker compose logs

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ—Ä—Ç—ã
netstat -tulpn | grep -E '3001|8088'

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±—Ä–∞–∑—ã
docker images | grep new_year_2025
```

## –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –±–µ–∑ CI/CD:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ
export CI_REGISTRY=localhost
export CI_COMMIT_TAG=dev

# –°–æ–±–µ—Ä–∏—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ
docker compose build
docker compose up -d

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ podman
podman-compose build
podman-compose up -d
```

## Best Practices

1. ‚úÖ **–í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ staging** –ø–µ—Ä–µ–¥ production
2. ‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ commit —Å–æ–æ–±—â–µ–Ω–∏—è**
3. ‚úÖ **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è**
4. ‚úÖ **–î–µ–ª–∞–π—Ç–µ backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö** –ø–µ—Ä–µ–¥ major –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
5. ‚úÖ **–î–µ—Ä–∂–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∞–∫—Ç—É–∞–ª—å–Ω–æ–π**
6. ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤** –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏:

```bash
# /APP/new_year_2025/.env
FRONTEND_PORT=8088
NODE_ENV=production
```

### –õ–æ–≥–∏

–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤:
- GitLab CI/CD: –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ GitLab
- Ansible: `logs/ansible-log.log`
- Docker: `docker compose logs`

### Backup

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π backup:

```bash
# Backup docker volumes (–µ—Å–ª–∏ –±—É–¥—É—Ç –¥–∞–Ω–Ω—ã–µ)
docker run --rm -v new_year_2025_data:/data -v $(pwd):/backup alpine tar czf /backup/backup-$(date +%Y%m%d).tar.gz /data
```

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ pipeline –≤ GitLab
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Ansible: `logs/ansible-log.log`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
4. –°–≤—è–∂–∏—Ç–µ—Å—å —Å DevOps –∫–æ–º–∞–Ω–¥–æ–π

